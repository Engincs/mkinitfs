#!/usr/bin/env atf-sh

. $(atf_get_srcdir)/test_env.sh

init_tests \
	initramfs_init_cmdline_root \
	initramfs_init_blacklist

fake_cmdline() {
	mkdir -p proc
	echo "$@" > proc/cmdline
}

fake_bin() {
	mkdir -p bin
	cat > bin/"$1"
	chmod +x bin/"$1"
}

fake_switch_root() {
	fake_bin switch_root <<-EOF
		#!/bin/sh
		echo "switch_root OK"
	EOF
}

initramfs_init_cmdline_root_body() {
	fake_cmdline "root=/dev/vda1"
	fake_switch_root

	atf_check -o match:"Alpine Init" \
		-o match:"nlplug-findfs" \
		-o match:"mount.*-o ro.*/dev/vda1.*/sysroot" \
		-o match:"switch_root OK" \
		initramfs-init
}

initramfs_init_blacklist_body() {
	fake_cmdline "root=/dev/vda1 blacklist=dummy,evbug"
	fake_switch_root
	atf_check -o match:"switch_root OK" \
		initramfs-init

	atf_check -o match:"blacklist dummy" \
		-o match:"blacklist evbug" \
		cat etc/modprobe.d/*
}


